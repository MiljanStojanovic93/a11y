import{_ as te}from"./Spinner.022385d5.js";import{d as A,p as R,b as h,o as f,q as F,g as V,f as l,j as e,r as k,s as oe,v as se,m as B,a as M,x as q,u as Y,i as z,S as O,e as n,l as D,n as L,c as U,t as N,h as W,w as re,y as le}from"./entry.bde0faaf.js";import{u as G,e as ae,a as H,d as J,c as ne,f as ie}from"./form.41b0e6ae.js";import{u as de}from"./fetch.7c567c4c.js";import"./_plugin-vue_export-helper.c27b6911.js";import"./screenSizes.19d85ebf.js";const ue=A({__name:"ProfileTable",props:{profiles:{}},setup(E){const T=E,b=R(()=>T.profiles.map(p=>({data:{userType:p.user_type,...p,name:`${p.email} ${p.username?`[${p.username}]`:""}`}})));return(p,i)=>{const y=h("Column"),P=h("TreeTable");return f(),F(P,{value:e(b),paginator:!0,rows:10,"rows-per-page-options":[10,25,50],"auto-layout":!0},{default:V(()=>[l(y,{field:"id",header:"Id",expander:""}),l(y,{field:"name",header:"User"}),l(y,{field:"email",header:"Email"}),l(y,{field:"userType",header:"User Type"})]),_:1},8,["value"])}}}),ce=A({__name:"ProjectTable",props:{projects:{}},setup(E){const T=E,b=R(()=>T.projects.map(p=>({data:{...p}})));return(p,i)=>{const y=h("Column"),P=h("TreeTable");return f(),F(P,{"auto-layout":!0,value:e(b),paginator:!0,rows:10,"rows-per-page-options":[10,25,50]},{default:V(()=>[l(y,{field:"id",header:"Id",expander:""}),l(y,{field:"name",header:"Name"}),l(y,{field:"description",header:"Description"})]),_:1},8,["value"])}}}),me=A({__name:"ClaimTable",props:{profilesToProjects:{},isLoading:{type:Boolean}},emits:["remove"],setup(E,{emit:T}){const b=k({name:"",email:"",role:""}),p=oe(),i=E,y=(d,u)=>{p.require({message:"Do you want to delete this record?",header:"Delete Confirmation",icon:"pi pi-info-circle",acceptClass:"p-button-danger",accept:()=>{P("remove",{userId:d,projectId:u})}})},P=T,S=R(()=>{const d=[];return i.profilesToProjects.forEach(u=>{var $;const{projectId:v,name:c,email:w,userId:j,metadata:g}=u;d[v]||(d[v]={key:`${v}_${j}`,data:{name:c,projectId:v,action:!1},children:[]}),($=d[v].children)==null||$.push({key:`${v}_${j}`,data:{email:w,userId:j,projectId:v,action:!0,role:g.user_role}})}),Object.values(d)});return(d,u)=>{const v=h("InputText"),c=h("Column"),w=h("Button"),j=h("TreeTable");return f(),F(j,{"auto-layout":!0,value:e(S),filters:e(b),"filter-mode":"lenient",paginator:!0,rows:10,"rows-per-page-options":[10,25,50]},{default:V(()=>[l(c,{field:"name",header:"Project Name",expander:"",sortable:""},{filter:V(()=>[l(v,{modelValue:e(b).name,"onUpdate:modelValue":u[0]||(u[0]=g=>e(b).name=g),type:"text",class:"p-column-filter",placeholder:"Filter by name"},null,8,["modelValue"])]),_:1}),l(c,{field:"email",header:"User Email"},{filter:V(()=>[l(v,{modelValue:e(b).email,"onUpdate:modelValue":u[1]||(u[1]=g=>e(b).email=g),type:"text",class:"p-column-filter",placeholder:"Filter by email"},null,8,["modelValue"])]),_:1}),l(c,{field:"role",header:"User Role"},{filter:V(()=>[l(v,{modelValue:e(b).role,"onUpdate:modelValue":u[2]||(u[2]=g=>e(b).role=g),type:"text",class:"p-column-filter",placeholder:"Filter by role"},null,8,["modelValue"])]),_:1}),l(c,{header:"Action",name:"action"},{body:V(g=>[g.node.data.action?(f(),F(w,{key:0,type:"button","aria-label":"Remove permission",title:"Remove permission",loading:d.isLoading,disabled:d.isLoading,severity:"danger",onClick:$=>y(g.node.data.userId,g.node.data.projectId)},{default:V(()=>u[3]||(u[3]=[se(" Remove ")])),_:2},1032,["loading","disabled","onClick"])):B("",!0)]),_:1})]),_:1},8,["value","filters"])}}}),pe={class:"mb-6 grid gap-3 md:grid-cols-2"},fe={key:0,class:"p-error mt-1"},_e={key:0,class:"p-error mt-1"},be=A({__name:"EditUserTypeForm",props:{users:{}},emits:["after-submit"],setup(E,{emit:T}){const{useFieldModel:b,handleSubmit:p,errors:i,submitCount:y,resetForm:P}=G({validationSchema:ae}),[S,d]=b(["user","userType"]),u=["auditor","viewer"],v=M(),c=q(),w=k(!1),j=T,{isSubmitted:g}=H(y),$=async(_,a,r)=>{const{data:t,error:o}=await v.rpc("set_claim",{uid:_,claim:a,value:r});return{data:t,error:o}},s=p(async({user:_,userType:a})=>{var r;try{if(w.value=!0,(r=Y().value)!=null&&r.id){const{error:o}=await $(_,"user_role",a);if(o)throw z(o)?new O(o):new Error((o==null?void 0:o.message)||"");c.add({severity:"success",summary:"Successfully edit user type",life:3e3}),P(),j("after-submit")}}catch(t){const{$handleError:o}=W();o(t)}finally{w.value=!1}},({errors:_})=>J(_));return(_,a)=>{const r=h("Dropdown"),t=h("Button"),o=h("Card");return f(),F(o,{class:"mb-6"},{content:V(()=>[n("form",{class:"mb-4",onSubmit:a[2]||(a[2]=(...m)=>e(s)&&e(s)(...m))},[a[5]||(a[5]=n("legend",{class:"mb-4 font-bold underline"},"Update user type",-1)),n("div",pe,[n("div",null,[a[3]||(a[3]=n("label",{for:"user_id"}," User ",-1)),l(r,{id:"user_id",modelValue:e(S),"onUpdate:modelValue":a[0]||(a[0]=m=>D(S)?S.value=m:null),options:_.users,"option-label":({full_name:m,email:x,user_type:I})=>`${m??x} [${I??"user type not set"}]`,"option-value":"id",placeholder:"Select",class:L(["md:w-14rem w-full",[{"p-invalid":e(i).user&&e(g)}]]),"data-testid":"claims-user-field",name:"user"},null,8,["modelValue","options","option-label","class"]),e(i).user&&e(g)?(f(),U("small",fe,N(e(i).user),1)):B("",!0)]),n("div",null,[a[4]||(a[4]=n("label",{for:"user_type"},"User type",-1)),l(r,{id:"user_type",modelValue:e(d),"onUpdate:modelValue":a[1]||(a[1]=m=>D(d)?d.value=m:null),options:u,placeholder:"Select",class:L(["md:w-14rem w-full",[{"p-invalid":e(i).userType&&e(g)}]]),"data-testid":"account-userType-field",name:"userType"},null,8,["modelValue","class"]),e(i).userType&&e(g)?(f(),U("small",_e,N(e(i).userType),1)):B("",!0)])]),l(t,{label:e(w)?"Loading ...":"Update",type:"submit",class:"p-button-lg w-full","data-testid":"edit-user-type-submit-button",loading:e(w),disabled:e(w)},null,8,["label","loading","disabled"])],32)]),_:1})}}}),ye={class:"mb-6 grid gap-3 md:grid-cols-2"},ve={key:0,class:"p-error mt-1"},je={key:0,class:"p-error mt-1"},ge=A({__name:"CreateProjectForm",emits:["after-submit"],setup(E,{emit:T}){const{useFieldModel:b,handleSubmit:p,errors:i,submitCount:y,resetForm:P}=G({validationSchema:ne}),[S,d]=b(["name","description"]),u=M(),v=q(),c=k(!1),w=T,{isSubmitted:j}=H(y),$=p(async({name:C,description:s})=>{var _;try{if(c.value=!0,(_=Y().value)!=null&&_.id){const{error:r}=await u.from("projects").insert({name:C,description:s});if(r)throw z(r)?new O(r):new Error((r==null?void 0:r.message)||"");v.add({severity:"success",summary:"Successfully create new project",life:3e3}),P(),w("after-submit")}}catch(a){const{$handleError:r}=W();r(a)}finally{c.value=!1}},({errors:C})=>J(C));return(C,s)=>{const _=h("InputText"),a=h("Button"),r=h("Card");return f(),F(r,{class:"mb-6"},{content:V(()=>[n("form",{class:"mb-4",onSubmit:s[2]||(s[2]=(...t)=>e($)&&e($)(...t))},[s[5]||(s[5]=n("legend",{class:"mb-4 font-bold underline"},"Create project",-1)),n("div",ye,[n("div",null,[s[3]||(s[3]=n("label",{for:"project_name"},"Name",-1)),l(_,{id:"project_name",modelValue:e(S),"onUpdate:modelValue":s[0]||(s[0]=t=>D(S)?S.value=t:null),class:L(["w-full",[{"p-invalid":e(i).name&&e(j)}]]),"data-testid":"create-project-name-field",name:"name"},null,8,["modelValue","class"]),e(i).name&&e(j)?(f(),U("small",ve,N(e(i).name),1)):B("",!0)]),n("div",null,[s[4]||(s[4]=n("label",{for:"project_description"},"Description",-1)),l(_,{id:"project_description",modelValue:e(d),"onUpdate:modelValue":s[1]||(s[1]=t=>D(d)?d.value=t:null),class:L(["w-full",[{"p-invalid":e(i).description&&e(j)}]]),"data-testid":"create-project-name-field",name:"description"},null,8,["modelValue","class"]),e(i).description&&e(j)?(f(),U("small",je,N(e(i).description),1)):B("",!0)])]),l(a,{label:e(c)?"Loading ...":"Create",type:"submit",class:"p-button-lg w-full","data-testid":"create-project-submit-button",loading:e(c),disabled:e(c)},null,8,["label","loading","disabled"])],32)]),_:1})}}}),we={class:"mb-6 grid gap-3 md:grid-cols-2"},he={key:0,class:"p-error mt-1"},Te={key:0,class:"p-error mt-1"},Pe=A({__name:"AddProfileToProjectForm",props:{profiles:{},projects:{}},emits:["after-submit"],setup(E,{emit:T}){const{useFieldModel:b,handleSubmit:p,errors:i,submitCount:y,resetForm:P}=G({validationSchema:ie}),[S,d]=b(["profile","project"]),u=M(),v=q(),c=k(!1),w=T,{isSubmitted:j}=H(y),$=p(async({profile:C,project:s})=>{var _;try{if(c.value=!0,(_=Y().value)!=null&&_.id){const{error:r}=await u.from("profile_project").insert({profile_id:C,project_id:s});if(r)throw z(r)?new O(r):new Error((r==null?void 0:r.message)||"");w("after-submit"),v.add({severity:"success",summary:"You successfully added profile to project",life:3e3}),P()}}catch(a){const{$handleError:r}=W();r(a)}finally{c.value=!1}},({errors:C})=>J(C));return(C,s)=>{const _=h("Dropdown"),a=h("Button"),r=h("Card");return f(),F(r,null,{content:V(()=>[n("form",{onSubmit:s[2]||(s[2]=(...t)=>e($)&&e($)(...t))},[s[5]||(s[5]=n("legend",{class:"mb-4 w-full font-bold"},"Add profile to projects",-1)),n("div",we,[n("div",null,[s[3]||(s[3]=n("label",{for:"profile_id"},"User",-1)),l(_,{id:"profile_id",modelValue:e(S),"onUpdate:modelValue":s[0]||(s[0]=t=>D(S)?S.value=t:null),options:C.profiles,"option-label":({full_name:t,email:o,user_type:m})=>`${t??o} [${m??"user type not set"}]`,"option-value":"id",placeholder:"Select",class:L(["w-full",[{"p-invalid":e(i).profile&&e(j)}]]),"data-testid":"claims-user-field",name:"client"},null,8,["modelValue","options","option-label","class"]),e(i).profile&&e(j)?(f(),U("small",he,N(e(i).profile),1)):B("",!0)]),n("div",null,[s[4]||(s[4]=n("label",{class:"mr-2",for:"project"}," Project ",-1)),l(_,{id:"project",modelValue:e(d),"onUpdate:modelValue":s[1]||(s[1]=t=>D(d)?d.value=t:null),options:C.projects,"option-label":({id:t,name:o})=>`${o} [${t}]`,"option-value":"id",placeholder:"Select",class:L(["w-full",[{"p-invalid":e(i).project&&e(j)}]]),"data-testid":"claims-project-field",name:"project"},null,8,["modelValue","options","option-label","class"]),e(i).project&&e(j)?(f(),U("small",Te,N(e(i).project),1)):B("",!0)])]),l(a,{label:e(c)?"Loading ...":"Update",type:"submit",class:"p-button-lg w-full","data-testid":"audit-submit-button",loading:e(c),disabled:e(c)},null,8,["label","loading","disabled"])],32)]),_:1})}}}),Se={class:"grid"},Ce={key:1},$e={class:"mr-4"},Ve={key:1,class:"ml-4"},Ue={class:"mr-4"},Fe={key:1,class:"ml-4"},ke={class:"mr-4"},Ee={key:1,class:"ml-4"},Re=A({__name:"admin",async setup(E){var r;let T,b;const p=M(),i=q(),y=k(!1),P=k(!0),S=k([]),d=k([]),u=k([]),v=k([]),c=t=>d.value.find(o=>o.id===t),w=R(()=>S.value.map(t=>{var o;return{...t,email:((o=c(t.id))==null?void 0:o.email)||""}})),j=R(()=>v.value.map(({profile_id:t,project_id:o})=>{const m=c(t),x=u.value.find(I=>I.id===o);return{email:(m==null?void 0:m.email)??"",name:(x==null?void 0:x.name)??"",userId:(m==null?void 0:m.id)??"",projectId:x.id,metadata:(m==null?void 0:m.app_metadata)||{}}})),{data:g}=([T,b]=re(()=>de("/api/users","$4y9e2A2xrw")),T=await T,b(),T);d.value=((r=g.value)==null?void 0:r.users)||[];async function $(){try{const{data:t}=await p.from("profiles").select("*");S.value=t||[]}catch(t){console.error("Error fetching profiles:",t)}}async function C(){try{const{data:t}=await p.from("projects").select("*");u.value=t||[]}catch(t){console.error("Error fetching projects:",t)}}async function s(){try{const{data:t}=await p.from("profile_project").select("*");v.value=t||[]}catch(t){console.error("Error fetching project profiles:",t)}}async function _(){try{P.value=!0,await Promise.all([$(),C(),s()]),P.value=!1}catch(t){console.error("Error fetching data:",t),P.value=!1}}async function a(t){y.value=!0;try{const{error:o}=await p.from("profile_project").delete().eq("profile_id",t.userId).eq("project_id",t.projectId);if(o)throw z(o)?new O(o):new Error((o==null?void 0:o.message)||"");s(),i.add({severity:"success",summary:"Permission deleted",life:3e3})}catch(o){const{$handleError:m}=W();m(o)}finally{y.value=!1}}return le(async()=>{await _()}),(t,o)=>{const m=te,x=ue,I=h("Card"),K=ce,Q=me,X=be,Z=ge,ee=Pe;return f(),U("div",Se,[o[4]||(o[4]=n("h1",null,"Admin page",-1)),e(P)?(f(),F(m,{key:0,class:"mx-auto my-10 w-40"})):(f(),U("div",Ce,[l(I,{class:"mb-6 overflow-auto"},{content:V(()=>[n("section",$e,[o[1]||(o[1]=n("h2",{class:"underline"},"Profile list",-1)),e(w).length?(f(),F(x,{key:0,profiles:e(w)},null,8,["profiles"])):(f(),U("p",Ve," Profile list is empty. "))])]),_:1}),l(I,{class:"mb-6 overflow-auto"},{content:V(()=>[n("section",Ue,[o[2]||(o[2]=n("h2",{class:"underline"},"Project list",-1)),e(u).length?(f(),F(K,{key:0,projects:e(u)},null,8,["projects"])):(f(),U("p",Fe," Project list is empty. "))])]),_:1}),l(I,{class:"mb-6 overflow-auto"},{content:V(()=>[n("section",ke,[o[3]||(o[3]=n("h2",{class:"underline"},"Profile per Project list",-1)),e(j).length?(f(),F(Q,{key:0,"is-loading":e(y),"profiles-to-projects":e(j),onRemove:a},null,8,["is-loading","profiles-to-projects"])):(f(),U("p",Ee," Profile per Project list is empty. "))])]),_:1}),l(X,{users:e(w),onAfterSubmit:$},null,8,["users"]),l(Z,{onAfterSubmit:C}),l(ee,{profiles:e(w),projects:e(u),onAfterSubmit:o[0]||(o[0]=xe=>s())},null,8,["profiles","projects"])]))])}}});export{Re as default};
