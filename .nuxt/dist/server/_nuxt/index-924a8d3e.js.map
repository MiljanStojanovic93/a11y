{"version":3,"file":"index-924a8d3e.js","sources":["../../../../pages/account/index.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport type { InvalidSubmissionContext } from 'vee-validate'\nimport { useForm } from 'vee-validate'\nimport { accountFormSchema } from 'validation/schema'\nimport type { Database, Json } from 'types/supabase'\nimport { displayFirstError } from '~/utils/form'\nimport { isSupabaseError, SupabaseError } from '~/plugins/error'\n\nconst user = useSupabaseUser()\nconst supabase = useSupabaseClient<Database>()\ninterface InitialValues {\n  email: string\n  username: string\n  fullName: string\n  avatarUrl: string\n  userType: Json\n}\n\nconst initialValues: InitialValues = {\n  email: '',\n  username: '',\n  fullName: '',\n  avatarUrl: '',\n  userType: '',\n}\n\nconst types = ['auditor', 'viewer']\n\nconst isLoading = ref(true)\n\nif (user.value) {\n  const { data: profile } = await supabase\n    .from('profiles')\n    .select('username, full_name, avatar_url, user_type')\n    .eq('id', user.value.id)\n    .single()\n\n  if (profile) {\n    initialValues.email = user.value.email || ''\n    initialValues.username = profile.username || ''\n    initialValues.fullName = profile.full_name || ''\n    initialValues.avatarUrl = profile.avatar_url || ''\n    initialValues.userType = profile.user_type || ''\n  }\n\n  isLoading.value = false\n}\n\nconst { useFieldModel, handleSubmit, errors, submitCount } = useForm({\n  validationSchema: accountFormSchema,\n  initialValues,\n})\n\nconst email = useFieldModel('email')\nconst username = useFieldModel('username')\nconst fullName = useFieldModel('fullName')\nconst avatarUrl = useFieldModel('avatarUrl')\nconst userType = useFieldModel('userType')\n\nconst { isSubmitted } = useValidation(submitCount)\nconst onInvalidSubmit = ({ errors }: InvalidSubmissionContext) =>\n  displayFirstError(errors)\n\nconst updateProfile = handleSubmit(async (values) => {\n  try {\n    isLoading.value = true\n    const user = useSupabaseUser()\n\n    if (user.value?.id) {\n      const { error } = await supabase\n        .from('profiles')\n        .update({\n          username: values.username,\n          full_name: values.fullName,\n          updated_at: new Date().toISOString(),\n        })\n        .eq('id', user.value.id)\n\n      if (error) {\n        if (isSupabaseError(error)) {\n          throw new SupabaseError(error)\n        }\n\n        throw new Error(error?.message || '')\n      }\n    }\n  } catch (error) {\n    const { $handleError } = useNuxtApp()\n\n    $handleError(error as Error | SupabaseError)\n  } finally {\n    isLoading.value = false\n  }\n}, onInvalidSubmit)\n</script>\n\n<template>\n  <div class=\"grid\">\n    <h1>Account Profile</h1>\n\n    <Card>\n      <template #content>\n        <form\n          v-if=\"user\"\n          @submit.prevent=\"updateProfile\"\n        >\n          <div class=\"mb-6 grid gap-6 md:grid-cols-2 md:items-start md:gap-x-8\">\n            <span class=\"w-full\">\n              <label for=\"email\">Email</label>\n              <InputText\n                id=\"email\"\n                v-model=\"email\"\n                disabled\n                readonly\n                class=\"w-full\"\n                data-testid=\"account-email-field\"\n                name=\"email\"\n                :class=\"[{ 'p-invalid': errors.email && isSubmitted }]\"\n              />\n              <small\n                v-if=\"errors.email && isSubmitted\"\n                class=\"p-error mt-1\"\n              >\n                {{ errors.email }}\n              </small>\n            </span>\n\n            <span class=\"w-full\">\n              <label for=\"username\">Username</label>\n              <InputText\n                id=\"username\"\n                v-model=\"username\"\n                class=\"w-full\"\n                data-testid=\"account-username-field\"\n                name=\"username\"\n                :class=\"[{ 'p-invalid': errors.username && isSubmitted }]\"\n              />\n              <small\n                v-if=\"errors.username && isSubmitted\"\n                class=\"p-error mt-1\"\n              >\n                {{ errors.username }}\n              </small>\n            </span>\n\n            <span class=\"w-full\">\n              <label for=\"full_name\">Full name</label>\n              <InputText\n                id=\"full_name\"\n                v-model=\"fullName\"\n                class=\"w-full\"\n                data-testid=\"account-fullName-field\"\n                name=\"fullName\"\n                :class=\"[{ 'p-invalid': errors.fullName && isSubmitted }]\"\n              />\n              <small\n                v-if=\"errors.fullName && isSubmitted\"\n                class=\"p-error mt-1\"\n              >\n                {{ errors.fullName }}\n              </small>\n            </span>\n\n            <span class=\"w-full\">\n              <label for=\"avatar_url\">Avatar url (soon)</label>\n              <InputText\n                id=\"avatar_url\"\n                v-model=\"avatarUrl\"\n                class=\"w-full\"\n                data-testid=\"account-avatarUrl-field\"\n                name=\"avatarUrl\"\n                :class=\"[{ 'p-invalid': errors.avatarUrl && isSubmitted }]\"\n                disabled\n                readonly\n              />\n              <small\n                v-if=\"errors.avatarUrl && isSubmitted\"\n                class=\"p-error mt-1\"\n              >\n                {{ errors.avatarUrl }}\n              </small>\n            </span>\n\n            <span class=\"w-full\">\n              <label for=\"user_type\">User type (soon)</label>\n              <Dropdown\n                id=\"user_type\"\n                v-model=\"userType\"\n                :options=\"types\"\n                placeholder=\"Select\"\n                class=\"md:w-14rem w-full\"\n                data-testid=\"account-userType-field\"\n                name=\"userType\"\n                :class=\"[{ 'p-invalid': errors.userType && isSubmitted }]\"\n              />\n              <small\n                v-if=\"errors.userType && isSubmitted\"\n                class=\"p-error mt-1\"\n              >\n                {{ errors.userType }}\n              </small>\n            </span>\n          </div>\n          <Button\n            :label=\"isLoading ? 'Loading ...' : 'Update'\"\n            type=\"submit\"\n            class=\"p-button-lg w-full\"\n            data-testid=\"account-submit-button\"\n            :loading=\"isLoading\"\n          />\n        </form>\n      </template>\n    </Card>\n  </div>\n</template>\n"],"names":["_withAsyncContext","errors","user"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAQA,UAAM,OAAO;AACb,UAAM,WAAW;AASjB,UAAM,gBAA+B;AAAA,MACnC,OAAO;AAAA,MACP,UAAU;AAAA,MACV,UAAU;AAAA,MACV,WAAW;AAAA,MACX,UAAU;AAAA,IAAA;AAGN,UAAA,QAAQ,CAAC,WAAW,QAAQ;AAE5B,UAAA,YAAY,IAAI,IAAI;AAE1B,QAAI,KAAK,OAAO;AACd,YAAM,EAAE,MAAM,aAAY,CAAA,QAAA,SAAA,IAAAA,iBAAA,MAAM,SAC7B,KAAK,UAAU,EACf,OAAO,4CAA4C,EACnD,GAAG,MAAM,KAAK,MAAM,EAAE,EACtB,QAAO;AAEV,UAAI,SAAS;AACG,sBAAA,QAAQ,KAAK,MAAM,SAAS;AAC5B,sBAAA,WAAW,QAAQ,YAAY;AAC/B,sBAAA,WAAW,QAAQ,aAAa;AAChC,sBAAA,YAAY,QAAQ,cAAc;AAClC,sBAAA,WAAW,QAAQ,aAAa;AAAA,MAChD;AAEA,gBAAU,QAAQ;AAAA,IACpB;AAEA,UAAM,EAAE,eAAe,cAAc,QAAQ,YAAA,IAAgB,QAAQ;AAAA,MACnE,kBAAkB;AAAA,MAClB;AAAA,IAAA,CACD;AAEK,UAAA,QAAQ,cAAc,OAAO;AAC7B,UAAA,WAAW,cAAc,UAAU;AACnC,UAAA,WAAW,cAAc,UAAU;AACnC,UAAA,YAAY,cAAc,WAAW;AACrC,UAAA,WAAW,cAAc,UAAU;AAEzC,UAAM,EAAE,YAAA,IAAgB,cAAc,WAAW;AACjD,UAAM,kBAAkB,CAAC,EAAE,QAAAC,QAAO,MAChC,kBAAkBA,OAAM;AAEpB,UAAA,gBAAgB,aAAa,OAAO,WAAW;;AAC/C,UAAA;AACF,kBAAU,QAAQ;AAClB,cAAMC,QAAO;AAETA,aAAAA,WAAK,UAALA,mBAAY,IAAI;AACZ,gBAAA,EAAE,UAAU,MAAM,SACrB,KAAK,UAAU,EACf,OAAO;AAAA,YACN,UAAU,OAAO;AAAA,YACjB,WAAW,OAAO;AAAA,YAClB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,UAAA,CACpC,EACA,GAAG,MAAMA,MAAK,MAAM,EAAE;AAEzB,cAAI,OAAO;AACL,gBAAA,gBAAgB,KAAK,GAAG;AACpB,oBAAA,IAAI,cAAc,KAAK;AAAA,YAC/B;AAEA,kBAAM,IAAI,OAAM,+BAAO,YAAW,EAAE;AAAA,UACtC;AAAA,QACF;AAAA,eACO,OAAO;AACR,cAAA,EAAE,iBAAiB;AAEzB,qBAAa,KAA8B;AAAA,MAAA,UAC3C;AACA,kBAAU,QAAQ;AAAA,MACpB;AAAA,OACC,eAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}