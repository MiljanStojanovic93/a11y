import{d as le,x as ye,a as he,W as je,X as Ae,w as G,u as Ve,r as F,$ as Se,p as ee,i as te,S as se,a2 as $e,b as h,o as p,c as _,e as l,f as c,j as e,l as S,g as P,q as X,F as re,z as ke,n as T,t as $,m as w,U as Te,_ as Ue,h as oe}from"./entry.bde0faaf.js";import{u as Ce,a as Oe,g as Pe,d as xe,h as Ee}from"./form.41b0e6ae.js";import{u as Fe}from"./fetch.7c567c4c.js";import{a as Ie}from"./screenSizes.19d85ebf.js";/**
  * vee-validate v4.11.8
  * (c) 2023 Abdelrahman Awad
  * @license MIT
  */const ae=s=>s!==null&&!!s&&typeof s=="object"&&!Array.isArray(s);function De(s){return typeof s=="object"&&s!==null}function ze(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}function Be(s){if(!De(s)||ze(s)!=="[object Object]")return!1;if(Object.getPrototypeOf(s)===null)return!0;let r=s;for(;Object.getPrototypeOf(r)!==null;)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(s)===r}function ie(s,r){return Object.keys(r).forEach(d=>{if(Be(r[d])){s[d]||(s[d]={}),ie(s[d],r[d]);return}s[d]=r[d]}),s}function Ne(s,r={abortEarly:!1}){return{__type:"VVTypedSchema",async parse(u){var j;try{return{value:await s.validate(u,Object.assign({},r)),errors:[]}}catch(i){const A=i;if(A.name!=="ValidationError")throw i;if(!(!((j=A.inner)===null||j===void 0)&&j.length)&&A.errors.length)return{errors:[{path:A.path,errors:A.errors}]};const z=A.inner.reduce((U,m)=>{const C=m.path||"";return U[C]||(U[C]={errors:[],path:C}),U[C].errors.push(...m.errors),U},{});return{errors:Object.values(z)}}},cast(u){try{return s.cast(u)}catch{const i=s.getDefault();return ae(i)&&ae(u)?ie(i,u):u}}}}const Le=Te(()=>Ue(()=>import("./AuditProcessingDialog.89b50f2e.js"),["./AuditProcessingDialog.89b50f2e.js","./nuxt-link.9e88655f.js","./entry.bde0faaf.js","./time.9f250bef.js"],import.meta.url).then(s=>s.default||s)),qe={class:"mb-4 grid grid-cols-[48px_1fr] items-center gap-3"},Me={class:"grid gap-6 md:grid-cols-2 md:items-start md:gap-x-8"},Re={class:"w-full"},He=["for"],We={key:0,class:"p-error mt-1"},Ge={class:"w-full"},Xe=["for"],Ye=["id"],Je={key:0,class:"p-error w-full"},Ke={class:"grid gap-6 md:grid-cols-2 md:gap-x-8 md:gap-y-4"},Qe={class:"w-full"},Ze={key:0,class:"p-error mt-1"},et={class:"w-full"},tt={key:0,class:"p-error mt-1"},st={class:"col-span-2"},ot={key:0,id:"description-help",class:"block"},at={key:1,class:"p-error mt-1"},lt={class:"grid"},rt={class:"align-items-center flex"},it={key:0,class:"grid w-full gap-6 gap-x-8 md:grid-cols-2"},nt={class:"w-full"},dt={class:"w-full"},ut={"aria-live":"assertive"},ct={key:0,class:"mb-4 mt-3 block text-red-700"},pt=le({__name:"AuditForm",async setup(s){var Z;let r,d;const{useFieldModel:u,handleSubmit:j,errors:i,submitCount:A,resetForm:z,setValues:U}=Ce({validationSchema:Ne(Ee)}),{isSubmitted:m}=Oe(A),{fields:C,push:ne,remove:de}=Pe("pages"),B=u("title"),k=u("project"),N=u("username"),L=u("password"),q=u("viewports"),f=u("noAxe"),M=u("description"),ue=ye(),x=he(),ce=je(),pe=Ae(),R=ce.query.baseAuditId;if(R){const{data:a,error:t}=([r,d]=G(()=>x.from("audits").select("*, projects(id)").eq("id",R).single()),r=await r,d(),r);if(t){const v={...t,message:`Failed to copy configuration from audit #${R}. ${t.message}`},{$handleError:g}=oe();g(v)}else U({pages:a.config.noAxe?[{selector:"",url:""}]:a.config.pages,title:a.config.title,project:(Z=a.projects)==null?void 0:Z.id,username:a.config.basicAuth.username,password:a.config.basicAuth.password,viewports:a.config.viewports,noAxe:a.config.noAxe,description:a.config.description}),pe.replace({query:{}})}const H=Ve(),W=F([]),Y=F([]),{isAdmin:me}=Se(),J=ee(()=>k.value&&(me.value||Y.value.includes(k.value)));if(H.value){const{data:a}=([r,d]=G(()=>x.from("projects").select("*")),r=await r,d(),r);W.value=a||[];const{data:t}=([r,d]=G(()=>x.from("profile_project").select("project_id").eq("profile_id",H.value.id)),r=await r,d(),r);Y.value=(t==null?void 0:t.map(v=>v.project_id))||[]}const O=F(!1),E=F(!1),I=F(),fe=ee(()=>{var a;return((a=W.value.find(t=>t.id===k.value))==null?void 0:a.name)||"this project"}),K=j(async a=>{var t;try{O.value=!0;let v={basicAuth:{password:"",username:""},pages:[],title:a.title,viewports:a.viewports.map(b=>b?b.filter(Boolean):[]),noAxe:a.noAxe,description:a.description||""};a.noAxe||(v={...v,basicAuth:{password:a.password||"",username:a.username||""},pages:a.pages||[]});const{data:g,error:y}=await x.from("audits").insert({project_id:a.project,profile_id:H.value.id,status:"draft",config:v}).select().single();if(y)throw te(y)?new se(y):new Error((y==null?void 0:y.message)||"");if(f.value)a.viewports.forEach(async b=>{const{error:V}=await x.from("axe").insert({audit_id:g.id,size:b==null?void 0:b.toString()}).select().single();if(V)throw te(V)?new se(V):new Error((V==null?void 0:V.message)||"")}),$e(`/audit/${g.id}`);else{const{error:b}=await Fe("/api/test",{method:"POST",body:g},"$V8eGduHtxW");b.value?ue.add({severity:"error",summary:(t=b.value)==null?void 0:t.message,life:3e3}):(I.value=g.id,E.value=!0)}}catch(v){const{$handleError:g}=oe();g(v)}finally{O.value=!1}},({errors:a})=>xe(a)),Q=(a=!0)=>{E.value=!1,I.value=void 0,O.value=!1,a&&z()};return(a,t)=>{const v=h("InputSwitch"),g=h("InputText"),y=h("Button"),b=h("AccordionTab"),V=h("Dropdown"),ge=h("Textarea"),be=h("MultiSelect"),_e=h("Password"),ve=h("Accordion"),we=Le;return p(),_("section",null,[t[17]||(t[17]=l("h2",{class:"mb-4"},"Configuration",-1)),l("form",{onSubmit:t[9]||(t[9]=(...o)=>e(K)&&e(K)(...o))},[l("div",qe,[c(v,{id:"no-axe",modelValue:e(f),"onUpdate:modelValue":t[0]||(t[0]=o=>S(f)?f.value=o:null),"data-testid":"audit-no-axe-field"},null,8,["modelValue"]),l("label",{for:"no-axe",class:"cursor-pointer",onClick:t[1]||(t[1]=o=>f.value=!e(f))}," Skip Axe automatic tests. I only want to test manually. ")]),c(ve,{"active-index":[0,1],multiple:!0},{default:P(()=>[e(f)?w("",!0):(p(),X(b,{key:0,header:"Pages"},{default:P(()=>[(p(!0),_(re,null,ke(e(C),(o,n)=>(p(),_("div",{key:`page-${n}`,class:"mb-4 grid gap-6 border-b border-b-gray-300 pb-4"},[l("div",Me,[l("div",Re,[l("label",{for:`url-${n}`},"Url",8,He),c(g,{id:`url-${n}`,modelValue:o.value.url,"onUpdate:modelValue":D=>o.value.url=D,class:T(["w-full",[{"p-invalid":(e(i)[`pages[${n}].url`]||e(i)[`pages[${n}]`])&&e(m)}]]),"data-testid":`audit-page-url-field-${n}`,name:`pages[${n}].url`},null,8,["id","modelValue","onUpdate:modelValue","data-testid","name","class"]),e(i)[`pages[${n}].url`]&&e(m)?(p(),_("small",We,$(e(i)[`pages[${n}].url`]),1)):w("",!0)]),l("div",Ge,[l("label",{for:`selector-${n}`},"HTML Selector",8,Xe),c(g,{id:`selector-${n}`,modelValue:o.value.selector,"onUpdate:modelValue":D=>o.value.selector=D,name:`pages[${n}].selector`,class:T(["w-full",[{"p-invalid":(e(i)[`pages[${n}].selector`]||e(i)[`pages[${n}]`])&&e(m)}]]),"aria-describedby":`selector-help-${n}`,"data-testid":`audit-page-selector-field-${n}`},null,8,["id","modelValue","onUpdate:modelValue","name","aria-describedby","data-testid","class"]),l("small",{id:`selector-help-${n}`}," Use .class or #id to choose selector to test, just one selector allowed. If empty whole document will be tested. ",8,Ye)]),e(i)[`pages[${n}]`]&&e(m)?(p(),_("small",Je,$(e(i)[`pages[${n}]`]),1)):w("",!0)]),n!==0?(p(),X(y,{key:0,label:"Remove page",variant:"secondary",class:"tracking-wider md:justify-self-start",icon:"pi pi-times","data-testid":`audit-remove-page-button-${n}`,outlined:"",pt:{icon:{"aria-hidden":!0}},onClick:D=>e(de)(n)},null,8,["data-testid","onClick"])):w("",!0)]))),128)),c(y,{label:"Add page",class:"w-full tracking-wider md:w-auto",icon:"pi pi-plus",outlined:"","data-testid":"audit-add-page-button",pt:{icon:{"aria-hidden":!0}},onClick:t[2]||(t[2]=o=>e(ne)({url:"",selector:""}))})]),_:1})),c(b,{header:"General"},{default:P(()=>[l("div",Ke,[l("div",Qe,[t[12]||(t[12]=l("label",{for:"title"},"Title",-1)),c(g,{id:"title",modelValue:e(B),"onUpdate:modelValue":t[3]||(t[3]=o=>S(B)?B.value=o:null),class:T(["w-full",[{"p-invalid":e(i).title&&e(m)}]]),"data-testid":"audit-title-field",name:"title"},null,8,["modelValue","class"]),e(i).title&&e(m)?(p(),_("small",Ze,$(e(i).title),1)):w("",!0)]),l("div",et,[t[13]||(t[13]=l("label",{id:"project-label",for:"project"}," Project ",-1)),c(V,{id:"project",modelValue:e(k),"onUpdate:modelValue":t[4]||(t[4]=o=>S(k)?k.value=o:null),options:e(W),"option-label":"name","option-value":"id",placeholder:"Select",class:T(["md:w-14rem w-full",[{"p-invalid":e(i).project&&e(m)}]]),"data-testid":"audit-project-field",name:"project","aria-labelledby":"project-label"},null,8,["modelValue","options","class"]),e(i).project&&e(m)?(p(),_("small",tt,$(e(i).project),1)):w("",!0)]),l("div",st,[t[14]||(t[14]=l("label",{for:"description"},"Description",-1)),c(ge,{id:"description",modelValue:e(M),"onUpdate:modelValue":t[5]||(t[5]=o=>S(M)?M.value=o:null),name:"description",class:"w-full",rows:"5","aria-describedby":e(f)?"description-help":void 0},null,8,["modelValue","aria-describedby"]),e(f)?(p(),_("small",ot," In case the audit only includes manual tests, be sure to disclose exactly what you'll be testing. ")):w("",!0),e(i).description&&e(m)?(p(),_("small",at,$(e(i).description),1)):w("",!0)])])]),_:1}),c(b,{header:e(f)?"Screen sizes / Devices":"Axe configuration"},{default:P(()=>[l("div",{class:T({"grid gap-6 md:grid-rows-2 md:gap-4":!e(f)})},[l("div",lt,[l("label",{id:"viewports",class:T({"sr-only":e(f)})}," Screen sizes / Devices ",2),c(be,{modelValue:e(q),"onUpdate:modelValue":t[6]||(t[6]=o=>S(q)?q.value=o:null),"aria-labelledby":"viewports",options:e(Ie),"option-label":"name","option-value":"viewport",placeholder:"Select screen sizes","max-selected-labels":3,name:"viewports",class:T([{"p-invalid":e(i).viewports&&e(m)}])},{option:P(o=>[l("div",rt,[l("div",null,$(o.option.name)+" ["+$(o.option.viewport.join(" x "))+"] ",1)])]),_:1},8,["modelValue","options","class"])]),e(f)?w("",!0):(p(),_("div",it,[l("div",nt,[t[15]||(t[15]=l("label",{for:"username"},"Basic Auth username",-1)),c(g,{id:"username",modelValue:e(N),"onUpdate:modelValue":t[7]||(t[7]=o=>S(N)?N.value=o:null),class:"w-full","data-testid":"audit-auth-username-field",name:"username"},null,8,["modelValue"])]),l("div",dt,[t[16]||(t[16]=l("label",{for:"password"},"Basic Auth password",-1)),c(_e,{id:"password",modelValue:e(L),"onUpdate:modelValue":t[8]||(t[8]=o=>S(L)?L.value=o:null),class:"w-full","input-class":"w-full","data-testid":"audit-auth-password-field",name:"password",feedback:!1,"toggle-mask":"",pt:{input:{autocomplete:"off"}}},null,8,["modelValue"])])]))],2)]),_:1},8,["header"])]),_:1}),l("div",ut,[e(k)&&!e(J)?(p(),_("small",ct," You don't have permission to add an audit to the "+$(e(fe))+". To gain access please contact the administrator. ",1)):w("",!0)]),c(y,{label:e(O)?"Sending...":"Send",type:"submit",class:"p-button-lg w-full","data-testid":"audit-submit-button",loading:e(O),disabled:e(O)||!e(J)},null,8,["label","loading","disabled"])],32),e(I)?(p(),X(we,{key:0,visible:e(E),"onUpdate:visible":t[10]||(t[10]=o=>S(E)?E.value=o:null),"audit-id":e(I),onClose:t[11]||(t[11]=o=>Q(o==null?void 0:o.resetAuditForm)),onHide:Q},null,8,["visible","audit-id"])):w("",!0)])}}}),vt=le({__name:"new",setup(s){return(r,d)=>{const u=pt,j=h("Card");return p(),_(re,null,[d[0]||(d[0]=l("div",{class:"grid"},[l("h1",null,"New audit")],-1)),c(j,null,{content:P(()=>[c(u)]),_:1})],64)}}});export{vt as default};
